<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notas - Apresenta√ß√£o</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <style>
    :root {
      --deep-blue: #042440;
      --sky-blue: #A2BEDC;
      --royal-purple: #4E499E;
      --soft-purple: #B793C9;
      --accent-teal: #2DD4BF;
      --text-light: #F4F6F8;
    }

    body {
      background: linear-gradient(135deg, var(--deep-blue) 0%, #0A1A2F 100%);
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }

    .checkbox-group input[type="checkbox"] {
      accent-color: var(--accent-teal);
      width: 1rem;
      height: 1rem;
    }

    table {
      box-shadow: 0 4px 15px rgba(78, 73, 158, 0.1);
      border: 1px solid var(--royal-purple);
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    button {
      background: var(--royal-purple) !important;
      border: 2px solid var(--soft-purple) !important;
      transition: all 0.3s ease !important;
    }

    button:hover:not(:disabled) {
      background: var(--accent-teal) !important;
      color: var(--royal-purple) !important;
      font-weight: 700 !important;
      letter-spacing: 0.05em !important;
      transform: translateY(-2px) !important;
    }

    #titulo-turma {
      font-family: 'Bangers', 'Comic Neue', sans-serif;
      letter-spacing: 0.05em;
      color: var(--accent-teal);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    #mensagem-status.bg-green-600 {
      background-color: var(--accent-teal) !important;
      color: var(--deep-blue) !important;
    }

    #mensagem-status.bg-red-600 {
      background-color: var(--soft-purple) !important;
    }

    thead {
      background-color: var(--deep-blue) !important;
    }

    thead th {
      color: var(--accent-teal) !important;
    }

    tbody tr:hover {
      background-color: rgba(45, 212, 191, 0.1) !important;
      box-shadow: inset 0 0 0 1px var(--accent-teal);
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }

    tbody tr {
      transition: all 0.2s ease;
    }

    tbody td {
      color: var(--text-light) !important;
    }

    #tabela-alunos td[id^="nota-"] {
      color: var(--accent-teal) !important;
      font-weight: bold;
    }

    .checkbox-group label {
      color: var(--sky-blue);
    }

    #nota-total {
      color: var(--accent-teal) !important;
    }
  </style>
</head>
<body class="text-text-light min-h-screen p-6">
  <div class="grid-container">
    <h1 id="titulo-turma" class="text-4xl font-bold mb-8 text-center">Notas - Apresenta√ß√£o</h1>

    <!-- Importar/Exportar JSON -->
    <div class="mb-8 flex flex-wrap gap-4 justify-center items-center">
      <button id="btn-importar" type="button" class="text-white font-semibold px-8 py-3 rounded-lg transition">
        üì§ Importar JSON
      </button>
      <button id="btn-exportar" type="button" class="text-white font-semibold px-8 py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        üì• Exportar JSON
      </button>
    <input type="file" id="input-arquivo" accept=".json" class="hidden">
  </div>

  <!-- Mensagem de status -->
  <div id="mensagem-status" class="hidden mb-4 p-3 rounded-lg text-center font-semibold"></div>

  <div class="overflow-x-auto card-section">
    <table class="min-w-full rounded-xl overflow-hidden">
      <thead>
        <tr>
          <th class="px-6 py-3 text-left">N¬∞</th>
          <th class="px-6 py-3 text-left">Nome</th>
          <th class="px-6 py-3 text-center">Nota Total</th>
          <th class="px-6 py-3 text-left">Corre√ß√£o Matem√°tica</th>
          <th class="px-6 py-3 text-left">Participa√ß√£o Individual</th>
          <th class="px-6 py-3 text-left">Anota√ß√µes</th>
          <th class="px-6 py-3 text-left">Sistematiza√ß√£o</th>
          <th class="px-6 py-3 text-left">Organiza√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabela-alunos" class="divide-y divide-gray-700"></tbody>
    </table>
  </div>

  <script>
    // Vari√°veis globais
    let dadosTurma = null;
    let alunos = [];
    let turmaAtual = '';
    
    const pesos = {
      "Corre√ß√£o Matem√°tica": [0, 0.5, 1, 1.5, 2],
      "Participa√ß√£o Individual": [0, 0.25, 0.5, 0.75, 1],
      "Anota√ß√µes": [0, 1],
      "Sistematiza√ß√£o": [0, 0.25, 0.5],
      "Organiza√ß√£o": [0, 0.25, 0.5]
    };

    const tabela = document.getElementById("tabela-alunos");
    const btnImportar = document.getElementById('btn-importar');
    const btnExportar = document.getElementById('btn-exportar');
    const inputArquivo = document.getElementById('input-arquivo');

    // Importa√ß√£o por arquivo JSON
    function importarJSON(arquivo) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const dados = JSON.parse(e.target.result);
          dadosTurma = dados;
          alunos = Array.isArray(dados.alunos) ? dados.alunos : [];
          turmaAtual = dados.turma || '';

          // Atualizar t√≠tulo principal e t√≠tulo da aba
          const titulo = document.getElementById('titulo-turma');
          if (titulo) {
            titulo.textContent = `Notas - Apresenta√ß√£o${dados.turma ? ' ' + dados.turma : ''}`;
          }
          document.title = `Notas - Apresenta√ß√£o${dados.turma ? ' ' + dados.turma : ''}`;

          criarTabela();
          btnExportar.disabled = false;
          // mostrarMensagem('‚úÖ Dados importados com sucesso!', 'sucesso');
        } catch (error) {
          mostrarMensagem('‚ùå Erro ao importar arquivo: ' + error.message, 'erro');
        }
      };
      reader.readAsText(arquivo);
    }

    // Fun√ß√£o para mostrar mensagem de status
    function mostrarMensagem(texto, tipo = 'sucesso') {
      const mensagem = document.getElementById('mensagem-status');
      mensagem.textContent = texto;
      mensagem.className = `mb-4 p-3 rounded-lg text-center font-semibold ${
        tipo === 'sucesso' ? 'bg-green-600' : 
        tipo === 'erro' ? 'bg-red-600' : 'bg-blue-600'
      }`;
      mensagem.classList.remove('hidden');
      setTimeout(() => mensagem.classList.add('hidden'), 3000);
    }

    // Fun√ß√£o para calcular nota de um aluno
    function calcularNota(id) {
      let total = 0;
      Object.keys(pesos).forEach(cat => {
        const selecionado = document.querySelector(`input[name='${cat}-${id}']:checked`);
        if (selecionado) total += parseFloat(selecionado.value);
      });
      document.getElementById(`nota-${id}`).textContent = total.toFixed(2).replace('.', ',');
    }

    // Fun√ß√£o para criar tabela
    function criarTabela() {
      tabela.innerHTML = ''; // Limpar tabela
      
      alunos.forEach((aluno, i) => {
        const tr = document.createElement("tr");
        tr.className = "transition";

        const colunas = `
          <td class="px-6 py-3">${String(aluno.numero).padStart(2, '0')}</td>
          <td class="px-6 py-3">${aluno.nome}</td>
          <td id="nota-${i}" class="px-6 py-3 text-center font-bold">0,00</td>
          ${Object.keys(pesos).map(categoria => `
            <td class="px-6 py-3 checkbox-group">
              ${pesos[categoria].map(valor => `
                <label class="inline-flex items-center mr-3">
                  <input type="checkbox" value="${valor}" name="${categoria}-${i}" ${aluno.notas && aluno.notas[categoria] === valor ? 'checked' : ''} />
                </label>
              `).join('')}
            </td>
          `).join('')}
        `;
        tr.innerHTML = colunas;
        tabela.appendChild(tr);
        
        // Calcular nota inicial se j√° tiver notas
        if (aluno.notas && Object.keys(aluno.notas).length > 0) {
          calcularNota(i);
        }
      });
      
      // Adicionar eventos aos checkboxes
      document.querySelectorAll("input[type='checkbox']").forEach(cb => {
        cb.addEventListener("change", () => {
          const id = cb.name.split('-').pop();
          const categoria = cb.name.replace(`-${id}`, '');
          const grupo = document.getElementsByName(cb.name);
          if (cb.checked) grupo.forEach(o => { if (o !== cb) o.checked = false; });

          calcularNota(id);
        });
      });
    }

    // Exporta√ß√£o para arquivo JSON
    function exportarJSON(e) {
      if (e && typeof e.preventDefault === 'function') e.preventDefault();
      if (e && typeof e.stopPropagation === 'function') e.stopPropagation();
      if (!dadosTurma) {
        mostrarMensagem('‚ùå Nenhum dado carregado', 'erro');
        return;
      }

      // Persistir estado visual antes de exportar (defensivo contra recarregamentos externos)
      try {
        const estado = {
          turma: dadosTurma.turma || '',
          alunos: alunos,
          checks: Array.from(document.querySelectorAll("input[type='checkbox']")).map(cb => ({
            name: cb.name,
            value: cb.value,
            checked: cb.checked
          }))
        };
        sessionStorage.setItem('estadoNotasPagina', JSON.stringify(estado));
      } catch {}

      const dados = {
        turma: dadosTurma.turma || 'Turma',
        data: new Date().toISOString().split('T')[0],
        alunos: []
      };
      
      alunos.forEach((aluno, i) => {
        const notasAluno = {};
        Object.keys(pesos).forEach(cat => {
          const selecionado = document.querySelector(`input[name='${cat}-${i}']:checked`);
          if (selecionado) {
            notasAluno[cat] = parseFloat(selecionado.value);
          }
        });
        
        dados.alunos.push({
          numero: aluno.numero,
          nome: aluno.nome,
          notas: notasAluno
        });
      });

      const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const nomeArquivo = `notas_${dados.turma}_${new Date().toISOString().split('T')[0]}.json`;
      a.download = nomeArquivo;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
      
      // mostrarMensagem('‚úÖ Arquivo JSON exportado com sucesso!', 'sucesso');
    }

    // Restaura estado se houver (ex.: se o navegador recarregar por algum motivo)
    window.addEventListener('DOMContentLoaded', () => {
      try {
        const salvo = sessionStorage.getItem('estadoNotasPagina');
        if (salvo) {
          const estado = JSON.parse(salvo);
          if (estado && Array.isArray(estado.alunos)) {
            dadosTurma = { turma: estado.turma };
            alunos = estado.alunos;
            turmaAtual = estado.turma || '';
            const titulo = document.getElementById('titulo-turma');
            if (titulo) titulo.textContent = `Notas - Apresenta√ß√£o${turmaAtual ? ' ' + turmaAtual : ''}`;
            document.title = `Notas - Apresenta√ß√£o${turmaAtual ? ' ' + turmaAtual : ''}`;
            criarTabela();
            // Reaplicar checks
            if (Array.isArray(estado.checks)) {
              estado.checks.forEach(c => {
                const el = document.querySelector(`input[name='${c.name}'][value='${c.value}']`);
                if (el) el.checked = !!c.checked;
              });
              // Recalcular notas
              alunos.forEach((_, i) => calcularNota(i));
            }
            btnExportar.disabled = false;
          }
        }
      } catch {}
    });

    // Eventos de importa√ß√£o/exporta√ß√£o
    btnImportar.addEventListener('click', () => inputArquivo.click());
    inputArquivo.addEventListener('change', (e) => {
      if (e.target.files && e.target.files.length > 0) {
        importarJSON(e.target.files[0]);
        e.target.value = '';
      }
    });
    btnExportar.addEventListener('click', (e) => exportarJSON(e));
  </script>
</body>
</html>
